<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LABORATORIO - JTBP FIX</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .card { background: #222; border: 2px solid #a68a44; padding: 20px; border-radius: 15px; max-width: 300px; margin: 20px auto; }
        .btn-play { background: #a68a44; color: black; border: none; padding: 15px 30px; font-weight: bold; border-radius: 10px; cursor: pointer; font-size: 16px; margin-bottom: 20px; width: 100%; }
        
        /* ESTILO DEL CORAZ√ìN */
        .btn-like { background: none; border: none; cursor: pointer; font-size: 30px; color: #555; transition: 0.3s; }
        .btn-like.liked { color: #ff4444; transform: scale(1.2); }
        .like-count { font-size: 16px; color: #888; display: block; margin-top: 5px; font-weight: bold; }
        .liked .like-count { color: #ff4444; }
        
        #log { background: #000; color: #0f0; font-family: monospace; padding: 10px; text-align: left; font-size: 12px; height: 150px; overflow-y: auto; border: 1px solid #444; margin-top: 20px; }
    </style>
</head>
<body>

    <h2 style="color: #a68a44;">üß™ LABORATORIO AISLADO</h2>
    <p>Prueba de Audio y Coraz√≥n</p>

    <div class="card">
        <h3 id="tiempo-pantalla">00:00</h3>
        <button class="btn-play" id="btn-play" onclick="arrancarAudio()">‚ñ∂Ô∏è REPRODUCIR</button>
        <audio id="mi-audio" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" crossorigin="anonymous"></audio>

        <hr style="border-color: #333; margin: 20px 0;">

        <button class="btn-like" id="btn-corazon" onclick="darLike()">
            ‚ù§Ô∏è <span class="like-count" id="contador-likes">100</span>
        </button>
    </div>

    <div id="log"><span>[SISTEMA INICIADO]</span><br></div>

    <script>
        const audio = document.getElementById('mi-audio');
        const btnCorazon = document.getElementById('btn-corazon');
        const contador = document.getElementById('contador-likes');
        const logBox = document.getElementById('log');

        function log(msg) { logBox.innerHTML += `> ${msg}<br>`; logBox.scrollTop = logBox.scrollHeight; }

        // ==========================================
        // 1. PRUEBA DEL CORAZ√ìN (LIKES)
        // ==========================================
        
        // Al cargar la p√°gina, verificamos si ya hab√≠a dado like en el pasado
        let estadoLike = localStorage.getItem('lab_like_test');
        if(estadoLike === 'true') {
            btnCorazon.classList.add('liked');
            contador.innerText = "101"; // Simulamos que ya sum√≥ en la DB
            log("‚ù§Ô∏è Coraz√≥n recuperado de la memoria (Rojo).");
        } else {
            log("ü§ç Coraz√≥n virgen (Blanco).");
        }

        function darLike() {
            // Verificamos el candado ANTES de sumar
            if(localStorage.getItem('lab_like_test') === 'true') {
                log("‚ö†Ô∏è Intento bloqueado: Ya le diste like antes.");
                alert("¬°Ya le diste like a esto! El candado funciona.");
                return; // Corta la funci√≥n aqu√≠, no suma nada.
            }

            // Si pasa el candado, suma y se pone rojo
            localStorage.setItem('lab_like_test', 'true');
            btnCorazon.classList.add('liked');
            contador.innerText = "101"; // Simula la suma en DB
            log("‚úÖ Like registrado y guardado en memoria.");
        }

        // ==========================================
        // 2. PRUEBA DE AUDIO (MEMORIA DE MINUTO)
        // ==========================================
        
        function arrancarAudio() {
            if(!audio.paused) {
                audio.pause();
                document.getElementById('btn-play').innerText = "‚ñ∂Ô∏è REPRODUCIR";
                log("‚è∏Ô∏è Audio Pausado.");
                return;
            }

            document.getElementById('btn-play').innerText = "‚è≥ CARGANDO...";
            
            // Le damos play PRIMERO, y cuando el celular responda, hacemos el salto
            let promesa = audio.play();
            
            if (promesa !== undefined) {
                promesa.then(_ => {
                    document.getElementById('btn-play').innerText = "‚è∏Ô∏è PAUSAR";
                    log("‚ñ∂Ô∏è Reproduciendo...");
                    
                    // Rescatar memoria DESPU√âS de que el audio ya arranc√≥ seguro
                    let memoria = localStorage.getItem('lab_audio_time');
                    if(memoria && parseFloat(memoria) > 5) {
                        audio.currentTime = parseFloat(memoria);
                        log(`‚è±Ô∏è Salto forzado al segundo: ${Math.floor(memoria)}`);
                    }
                }).catch(error => {
                    log("‚ùå Error al reproducir: " + error);
                });
            }
        }

        // Guardar la memoria cada vez que avanza el reloj
        audio.ontimeupdate = () => {
            let m = Math.floor(audio.currentTime / 60);
            let s = Math.floor(audio.currentTime % 60);
            document.getElementById('tiempo-pantalla').innerText = `${m}:${s < 10 ? '0':''}${s}`;
            
            if(audio.currentTime > 5) {
                localStorage.setItem('lab_audio_time', audio.currentTime);
            }
        };

    </script>
</body>
</html>
