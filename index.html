<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LABORATORIO - MOTOR JTBP</title>
    <style>
        body { 
            background: #121212; color: #00ff00; font-family: monospace; 
            padding: 20px; text-align: center; margin: 0;
        }
        h2 { color: #FFD700; }
        .track-list { 
            margin: 20px 0; display: flex; flex-direction: column; gap: 10px; align-items: center; 
        }
        button { 
            background: #333; color: white; border: 1px solid #00ff00; 
            padding: 15px; width: 90%; max-width: 400px; cursor: pointer; 
            border-radius: 5px; font-size: 16px; transition: 0.3s;
        }
        button.active { 
            background: #00ff00; color: #000; font-weight: bold; transform: scale(1.05);
        }
        audio { 
            width: 90%; max-width: 400px; margin-top: 20px; outline: none;
        }
        .console { 
            background: #000; border: 1px solid #444; padding: 10px; margin-top: 20px; 
            max-width: 400px; margin-left: auto; margin-right: auto; text-align: left; 
            font-size: 12px; height: 150px; overflow-y: auto; border-radius: 5px; color: #aaa;
        }
        .console span { color: #FFD700; }
    </style>
</head>
<body>
    <h2>üîß BANCO DE PRUEBAS: JTBP</h2>
    <p>Probando: Piloto Autom√°tico y Memoria</p>
    
    <audio id="miAudio" controls></audio>
    
    <div class="track-list" id="playlist">
        </div>

    <div class="console" id="log">
        <span>[SISTEMA]</span> Motor de audio encendido...<br>
    </div>

    <script>
        // 1. CANCIONES DE PRUEBA (Para no gastar su base de datos)
        const pistas = [
            { id: "pista_001", titulo: "Audio de Prueba 1", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
            { id: "pista_002", titulo: "Audio de Prueba 2", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
            { id: "pista_003", titulo: "Audio de Prueba 3", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" }
        ];

        let pistaActual = 0;
        const reproductor = document.getElementById('miAudio');
        const logBox = document.getElementById('log');

        // Funci√≥n para escribir en la consolita verde
        function log(msg) { 
            logBox.innerHTML += `> ${msg}<br>`; 
            logBox.scrollTop = logBox.scrollHeight; 
        }

        // Crear los botones en pantalla
        const playlistDiv = document.getElementById('playlist');
        pistas.forEach((p, index) => {
            let btn = document.createElement('button');
            btn.id = `btn-${index}`;
            btn.innerText = `‚ñ∂Ô∏è ${p.titulo}`;
            btn.onclick = () => cargarPista(index, true);
            playlistDiv.appendChild(btn);
        });

        // 2. FUNCI√ìN PRINCIPAL: CARGAR EL AUDIO
        function cargarPista(index, reproducir = false) {
            pistaActual = index;
            reproductor.src = pistas[index].url;
            
            // Pintar el bot√≥n activo
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${index}`).classList.add('active');

            log(`Cargando: <span>${pistas[index].titulo}</span>`);

            // üî• MAGIA 1: BUSCAR MEMORIA GUARDADA
            let memoria = localStorage.getItem(`jtbp_memoria_${pistas[index].id}`);
            
            // El reproductor necesita cargar un poco antes de saltar al minuto exacto
            reproductor.onloadedmetadata = () => {
                if (memoria && parseFloat(memoria) > 0) {
                    reproductor.currentTime = parseFloat(memoria);
                    let min = Math.floor(memoria / 60);
                    let seg = Math.floor(memoria % 60);
                    log(`‚è±Ô∏è Memoria encontrada: Saltando al minuto <span>${min}:${seg}</span>`);
                } else {
                    log(`‚è±Ô∏è Pista nueva. Iniciando desde el segundo 0.`);
                }
                if(reproducir) reproductor.play();
            };
        }

        // üî• MAGIA 2: GUARDAR LA MEMORIA MIENTRAS SUENA
        // Esto se ejecuta cada vez que el reloj del audio avanza
        reproductor.addEventListener('timeupdate', () => {
            if (reproductor.currentTime > 0) {
                // Guardar en el disco duro del celular
                localStorage.setItem(`jtbp_memoria_${pistas[pistaActual].id}`, reproductor.currentTime);
            }
        });

        // üî• MAGIA 3: PILOTO AUTOM√ÅTICO (SIGUIENTE CANCI√ìN)
        reproductor.addEventListener('ended', () => {
            log(`‚úÖ Pista terminada.`);
            
            // Borrar la memoria porque ya escuch√≥ todo el podcast
            localStorage.removeItem(`jtbp_memoria_${pistas[pistaActual].id}`);
            
            let siguiente = pistaActual + 1;
            
            // Si hay m√°s pistas, arranca la siguiente
            if (siguiente < pistas.length) {
                log(`üîÑ Piloto Autom√°tico: Arrancando la siguiente...`);
                cargarPista(siguiente, true);
            } else {
                log(`üèÅ Fin de la lista de reproducci√≥n.`);
            }
        });

        // Al abrir la p√°gina, cargar la primera pista (sin darle Play autom√°tico por pol√≠ticas de navegadores)
        cargarPista(0, false);
    </script>
</body>
</html>
